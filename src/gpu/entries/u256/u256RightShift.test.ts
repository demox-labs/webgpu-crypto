import puppeteer from "puppeteer";
import { Browser } from "puppeteer";
import { bigIntToU32Array, gpuU32Inputs, gpuU32PuppeteerString, u32ArrayToBigInts } from "../../utils";
import { FIELD_SIZE } from "../../U32Sizes";

describe("u256RightShift", () => {
  let browser: Browser;
  beforeAll(async () => {
    browser = await puppeteer.launch({
      executablePath: '/Applications/Google\ Chrome\ Beta.app/Contents/MacOS/Google\ Chrome\ Beta',
      devtools: true,
      headless: false,
      args: ['#enable-webgpu-developer-features']
    });

    const page = (await browser.pages())[0];
    await page.goto("http://localhost:4000");
  });

  afterAll(async () => {
    await browser.close();
  });
// 11111111111111111111111111111111
// 00000000000000000000000000000000
  it.each([
    [BigInt(8), 1, BigInt(4)],
    [BigInt(4), 1, BigInt(2)],
    [BigInt(2), 1, BigInt(1)],
    [BigInt(1), 1, BigInt(0)],
    [BigInt('71777214294589695'), 1, BigInt('35888607147294847')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 1, BigInt('57896044618658097711785492504343953926634992332820282019728792003956564819967')],
    [BigInt('26959946679704843269824881528045047742743426419429633011166591582216'), 5, BigInt('842498333740776352182027547751407741960732075607176031598955986944')],
    // (1, 0, 0, 0, 0, 0, 0, 0)
    [BigInt('26959946667150639794667015087019630673637144422540572481103610249216'), 1, BigInt('13479973333575319897333507543509815336818572211270286240551805124608')],
    // (0, 1, 0, 0, 0, 0, 0, 0)
    [BigInt('6277101735386680763835789423207666416102355444464034512896'), 1, BigInt('3138550867693340381917894711603833208051177722232017256448')],
    // (0, 0, 1, 0, 0, 0, 0, 0)
    [BigInt('1461501637330902918203684832716283019655932542976'), 1, BigInt('730750818665451459101842416358141509827966271488')],
    // (0, 0, 0, 1, 0, 0, 0, 0)
    [BigInt('340282366920938463463374607431768211456'), 1, BigInt('170141183460469231731687303715884105728')],
    // (0, 0, 0, 0, 1, 0, 0, 0)
    [BigInt('79228162514264337593543950336'), 1, BigInt('39614081257132168796771975168')],
    // (0, 0, 0, 0, 0, 1, 0, 0)
    [BigInt('18446744073709551616'), 1, BigInt('9223372036854775808')],
    // (0, 0, 0, 0, 0, 0, 1, 0)
    [BigInt('4294967296'), 1, BigInt('2147483648')],
    // Big shift tests
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 256, BigInt(0)],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 224, BigInt(4294967295)],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 192, BigInt('18446744073709551615')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 160, BigInt('79228162514264337593543950335')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 128, BigInt('340282366920938463463374607431768211455')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 96, BigInt('1461501637330902918203684832716283019655932542975')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 64, BigInt('6277101735386680763835789423207666416102355444464034512895')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 32, BigInt('26959946667150639794667015087019630673637144422540572481103610249215')],
    // 5 leftover to shift
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 251, BigInt(31)],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 219, BigInt('137438953471')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 187, BigInt('590295810358705651711')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 155, BigInt('2535301200456458802993406410751')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 123, BigInt('10889035741470030830827987437816582766591')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 91, BigInt('46768052394588893382517914646921056628989841375231')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 59, BigInt('200867255532373784442745261542645325315275374222849104412671')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 27, BigInt('862718293348820473429344482784628181556388621521298319395315527974911')],
    // 31 leftover to shift
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 225, BigInt('2147483647')],
    [BigInt('115792089237316195423570985008687907853269984665640564039457584007913129639935'), 193, BigInt('9223372036854775807')],
  ])('should right shift the uint256 by shift', async (input1: bigint, shift: number, expected: bigint) => {
    const u32Input1: gpuU32Inputs = { u32Inputs: bigIntToU32Array(input1), individualInputSize: FIELD_SIZE };

    const result = await ((await browser.pages())[0]).evaluate(`(u256_right_shift)(${gpuU32PuppeteerString(u32Input1)}, ${shift})`);
    const arr = Object.values(result as object);
    const uint32ArrayResult = new Uint32Array(arr);
    const bigIntResult = u32ArrayToBigInts(uint32ArrayResult)[0];

    expect(bigIntResult.toString()).toEqual(expected.toString());
  });
});